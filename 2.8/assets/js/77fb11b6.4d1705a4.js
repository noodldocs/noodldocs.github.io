"use strict";(self.webpackChunknoodl_docs=self.webpackChunknoodl_docs||[]).push([[7655],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>m});var n=a(67294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function r(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=n.createContext({}),d=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},p=function(e){var t=d(e.components);return n.createElement(l.Provider,{value:t},e.children)},c="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,p=r(e,["components","mdxType","originalType","parentName"]),c=d(a),u=i,m=c["".concat(l,".").concat(u)]||c[u]||h[u]||o;return a?n.createElement(m,s(s({ref:t},p),{},{components:a})):n.createElement(m,s({ref:t},p))}));function m(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=a.length,s=new Array(o);s[0]=u;var r={};for(var l in t)hasOwnProperty.call(t,l)&&(r[l]=t[l]);r.originalType=e,r[c]="string"==typeof e?e:i,s[1]=r;for(var d=2;d<o;d++)s[d]=a[d];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},70506:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>d});var n=a(87462),i=(a(67294),a(3905));const o={title:"Emal Verification",hide_title:!0},s="Email Verification",r={unversionedId:"guides/cloud-logic/email-verification",id:"guides/cloud-logic/email-verification",title:"Emal Verification",description:"Cloud functions play an important role when creating different log in and sign up flows. Using the nodes Sign Up, Log In and Log Out you can create the most basic flow that will have the user sign up with a username, optionally email, and password and log in with username and password.",source:"@site/docs/guides/cloud-logic/email-verification.md",sourceDirName:"guides/cloud-logic",slug:"/guides/cloud-logic/email-verification",permalink:"/2.8/docs/guides/cloud-logic/email-verification",draft:!1,tags:[],version:"current",frontMatter:{title:"Emal Verification",hide_title:!0},sidebar:"docsSidebar",previous:{title:"Introduction to Cloud Functions",permalink:"/2.8/docs/guides/cloud-logic/introduction"},next:{title:"Scheduled Jobs",permalink:"/2.8/docs/guides/cloud-logic/scheduled-jobs"}},l={},d=[{value:"Settings",id:"settings",level:2},{value:"Signing up",id:"signing-up",level:2},{value:"Verifyng the email",id:"verifyng-the-email",level:2},{value:"Reset Password",id:"reset-password",level:2}],p={toc:d},c="wrapper";function h(e){let{components:t,...o}=e;return(0,i.kt)(c,(0,n.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"email-verification"},"Email Verification"),(0,i.kt)("p",null,"Cloud functions play an important role when creating different log in and sign up flows. Using the nodes ",(0,i.kt)("a",{parentName:"p",href:"/nodes/data/user/sign-up"},"Sign Up"),", ",(0,i.kt)("a",{parentName:"p",href:"/nodes/data/user/log-in"},"Log In")," and ",(0,i.kt)("a",{parentName:"p",href:"/nodes/data/user/log-out"},"Log Out")," you can create the most basic flow that will have the user sign up with a username, optionally email, and password and log in with username and password."),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"It's common to use email for both ",(0,i.kt)("strong",{parentName:"p"},"username")," and ",(0,i.kt)("strong",{parentName:"p"},"email")," when signing up, so you only ask the user for email and password, one less thing to remeber right.")),(0,i.kt)("p",null,"Once logged in you can use the ",(0,i.kt)("a",{parentName:"p",href:"/docs/guides/cloud-data/access-control"},"Access Control")," functions of the cloud database to control what a user has access to and not. The built in role system will allow you to create features like teams/groups of users."),(0,i.kt)("p",null,"This is a great way to get started and focus on building your application. But once you start getting to the point where you want to expose it to more users often you need a more solid sign up and log in flow. The first addition is likely the need to verify the email of users and allow them to reset the password and this is what we will cover in this guide."),(0,i.kt)("p",null,"There is a project template that contains a more complete sign up and log in flow that also covers sending emails to users on sign up, editing the profile etc, and it uses cloud functions to do some of these things that cannot be performed from the frontend for security reasons (cloud functions always have full access to the database)."),(0,i.kt)("p",null,"You can either start a new project from the template, or you can import the cloud functions into your existing project. We will review them here in this guide, case by case."),(0,i.kt)("div",{className:"ndl-image-with-background l"},(0,i.kt)("p",null,(0,i.kt)("img",{src:a(7069).Z,width:"760",height:"690"}))),(0,i.kt)("h2",{id:"settings"},"Settings"),(0,i.kt)("p",null,"In order to make the email verification process work there are a few configuration parameters that need to be provided. This is done by opening up the dashboard for your ",(0,i.kt)("strong",{parentName:"p"},"Cloud Serivce")," and navigating to the ",(0,i.kt)("strong",{parentName:"p"},"Config")," tab using the sidebar. You can learn more about config parameters by looking at the ",(0,i.kt)("a",{parentName:"p",href:"/nodes/data/cloud-data/config"},"Config")," node. The configuration parameters you need a are shown below:"),(0,i.kt)("div",{className:"ndl-image-with-background xl"},(0,i.kt)("p",null,(0,i.kt)("img",{src:a(38882).Z,width:"1960",height:"306"}))),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"EmailVerificationDomain")," Here you need to enter the domain where your application is deployed starting with ",(0,i.kt)("inlineCode",{parentName:"li"},"https://"),". This is used for the links in the verification emails. When running locally this will automatically be ",(0,i.kt)("inlineCode",{parentName:"li"},"http://localhost:8574"),", this is where the local Noodl web server is running."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"EmailVerificationFrom"),' This is where you put the email address that should be used as the "from" email when sending verification emails to users. It\'s important that this is a valid email with ',(0,i.kt)("strong",{parentName:"li"},"Send Grid")," (the email sending service we use for the application)."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"SendGridAPIKey")," The project template and email verification prefabs use ",(0,i.kt)("a",{parentName:"li",href:"https://sendgrid.com/"},"SendGrid")," as an email service, to use it you need to sign up and get an account (it's free to test). Then create an API Key and put it in the config. More info on how to use Send Grid with Noodl can be found ",(0,i.kt)("a",{parentName:"li",href:"/library/prefabs/sendgrid"},"here"),".")),(0,i.kt)("h2",{id:"signing-up"},"Signing up"),(0,i.kt)("p",null,"Signing up is done with the ",(0,i.kt)("a",{parentName:"p",href:"/nodes/data/user/sign-up"},"Sign Up")," action node. After the user has successfully signed up the cloud function ",(0,i.kt)("strong",{parentName:"p"},"Send Verification Email")," is called. This function will send an email to the address provided by the user."),(0,i.kt)("div",{className:"ndl-image-with-background xl"},(0,i.kt)("p",null,(0,i.kt)("img",{src:a(33384).Z,width:"1718",height:"992"}))),(0,i.kt)("p",null,"Let's take a closer look at the cloud function. There is no need to dive into the details but it's good to review the main flow and blocks. The cloud function is found in the cloud function tab, in the ",(0,i.kt)("strong",{parentName:"p"},"Sign Up")," folder, it's called ",(0,i.kt)("strong",{parentName:"p"},"Send Verification Email"),". The first this when the function is started is that a ",(0,i.kt)("strong",{parentName:"p"},"Request Email Verification")," action component is used."),(0,i.kt)("div",{className:"ndl-image-with-background xl"},(0,i.kt)("p",null,(0,i.kt)("img",{src:a(21699).Z,width:"1422",height:"910"}))),(0,i.kt)("p",null,"This action create a secret token (a random string of characters, sort of a temporary password) that it stores with the current user. This token will later be sent to the user as part of an email. If the email is already verified a signal will be emitted on ",(0,i.kt)("strong",{parentName:"p"},"Email Is Verified")," which we will return as an error result for the cloud function."),(0,i.kt)("p",null,"The next part is actually sending the email to the user. This is done in the function with the ",(0,i.kt)("strong",{parentName:"p"},"Format Email")," and ",(0,i.kt)("strong",{parentName:"p"},"Send Email")," action components."),(0,i.kt)("div",{className:"ndl-image-with-background xl"},(0,i.kt)("p",null,(0,i.kt)("img",{src:a(79703).Z,width:"1008",height:"530"}))),(0,i.kt)("p",null,"The ",(0,i.kt)("strong",{parentName:"p"},"Format Email")," action takes as input the verification token and the email of the user and creates an email with a link. You can look at the properties of the ",(0,i.kt)("strong",{parentName:"p"},"Format Email")," node to see the content of the email."),(0,i.kt)("div",{className:"ndl-image-with-background l"},(0,i.kt)("p",null,(0,i.kt)("img",{src:a(3347).Z,width:"760",height:"354"}))),(0,i.kt)("p",null,"As you can see it creates an email containing an HTML link, this link uses some fancy template syntax."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"$Domain")," This will be replaced by the format email node to the domain where your application is deployed, so that the link will take you back to the app. More on this later."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"{Token}")," This is the generated token from before."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"{Email}")," This is the email for the user, it will be used to fetch the user and marked the email as verified in the next step.")),(0,i.kt)("p",null,"The ",(0,i.kt)("strong",{parentName:"p"},"Format Email")," node outputs the final email with the correct values for the above placeholders insterted. This email content is then sent to the ",(0,i.kt)("strong",{parentName:"p"},"Send Email")," node that actually sends the email to the user. "),(0,i.kt)("div",{className:"ndl-image-with-background l"},(0,i.kt)("p",null,(0,i.kt)("img",{src:a(96065).Z,width:"976",height:"770"}))),(0,i.kt)("p",null,"That's it. Now the user should have a fresh email with the subject ",(0,i.kt)("strong",{parentName:"p"},"Email Verification!")," in it's inbox. You can edit the ",(0,i.kt)("strong",{parentName:"p"},"Subject")," property of the ",(0,i.kt)("strong",{parentName:"p"},"Send Email")," action."),(0,i.kt)("h2",{id:"verifyng-the-email"},"Verifyng the email"),(0,i.kt)("p",null,"We need one more thing in place for the email verification flow to work. We need the page that the link in the verification email points to. After the ",(0,i.kt)("strong",{parentName:"p"},"Format Email")," action have formatted the email template and inserted the ",(0,i.kt)("strong",{parentName:"p"},"Token"),", ",(0,i.kt)("strong",{parentName:"p"},"Email")," and ",(0,i.kt)("strong",{parentName:"p"},"Domain")," the resulting link will look something like this."),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},'<a href="https://your-app.sandbox.noodl.app/verify-email?token=abc&email=user@email.com">verify</a>')),(0,i.kt)("p",null,"This little thing will send the user back to your app (remember you can use ",(0,i.kt)("inlineCode",{parentName:"p"},"http://localhost:8574")," as domain for testing, before your app is deployed) and specifically to the page ",(0,i.kt)("inlineCode",{parentName:"p"},"/verify-email"),". So, let's take a look at the page in the project template."),(0,i.kt)("div",{className:"ndl-image-with-background xl"},(0,i.kt)("p",null,(0,i.kt)("img",{src:a(56182).Z,width:"1808",height:"944"}))),(0,i.kt)("p",null,"There is a lot of stuff here but the important things is the ",(0,i.kt)("strong",{parentName:"p"},"Page Inputs")," where we get the ",(0,i.kt)("strong",{parentName:"p"},"Token")," and ",(0,i.kt)("strong",{parentName:"p"},"Email")," as part of the query parameters in the link (the stuff after the ",(0,i.kt)("inlineCode",{parentName:"p"},"?")," in the link), these are passed to the ",(0,i.kt)("strong",{parentName:"p"},"Sign Up / Verify Email")," cloud function that is called as soon as the page is loaded with the ",(0,i.kt)("strong",{parentName:"p"},"Did Mount")," signal."),(0,i.kt)("p",null,"If it succeeds, the email was verified and the user is sent to the log in page of the app with the ",(0,i.kt)("strong",{parentName:"p"},"Navigate")," node and a toast message is shown. If it fails, a message is displayed on the screen and a toast is shown using the ",(0,i.kt)("strong",{parentName:"p"},"Show Toast")," component (you can find this among the prefabs and install it into your project, same for the ",(0,i.kt)("strong",{parentName:"p"},"Loading Spinner"),")."),(0,i.kt)("p",null,"Once logged in to your app you can inspect the user object by hovering over any ",(0,i.kt)("strong",{parentName:"p"},"User")," node. Here you can see some properties that have been set by the email verification cloud functions."),(0,i.kt)("div",{className:"ndl-image-with-background l"},(0,i.kt)("p",null,(0,i.kt)("img",{src:a(37720).Z,width:"764",height:"698"}))),(0,i.kt)("p",null,"The most important is the ",(0,i.kt)("strong",{parentName:"p"},"emailVerified")," property of the user, this indicates if the user have verified their email of not. In the sign up project template the user is actually send to the home screen of the app even if the email address is not verfied and a banner is shown. You could for instance only enable certain parts of the application if the user have verified their email."),(0,i.kt)("p",null,"If the email was not received properly of if the user would like to have another verification email sent you can simply call the ",(0,i.kt)("strong",{parentName:"p"},"Sign Up / Send Verification Email")," cloud function again."),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"If you update the email with the ",(0,i.kt)("strong",{parentName:"p"},"Set User Properties")," action node, it will automatically switch the ",(0,i.kt)("strong",{parentName:"p"},"emailVerified")," property of the user to false.")),(0,i.kt)("h2",{id:"reset-password"},"Reset Password"),(0,i.kt)("p",null,"Resetting a user password when it's been lost follows the same pattern as sending an email for verification. First you need to present some sort of UI where the user can enter their email address to recover their password."),(0,i.kt)("div",{className:"ndl-image-with-background l"},(0,i.kt)("p",null,(0,i.kt)("img",{src:a(93627).Z,width:"880",height:"644"}))),(0,i.kt)("p",null,"There is a function called ",(0,i.kt)("strong",{parentName:"p"},"Sign Up / Request Password Reset")," that simply accepts an ",(0,i.kt)("strong",{parentName:"p"},"Email")," and it can be called without the user being logged in. "),(0,i.kt)("div",{className:"ndl-image-with-background xl"},(0,i.kt)("p",null,(0,i.kt)("img",{src:a(46999).Z,width:"1058",height:"520"}))),(0,i.kt)("p",null,"The cloud function follow pretty much the same pattern as when sending email verifications. It will send an email to the user with a link containing a secret token just like when veryfing the email address."),(0,i.kt)("div",{className:"ndl-image-with-background xl"},(0,i.kt)("p",null,(0,i.kt)("img",{src:a(77383).Z,width:"1510",height:"718"}))),(0,i.kt)("p",null,"The ",(0,i.kt)("strong",{parentName:"p"},"Request Password Reset")," action will generate the secret token which is passed to the ",(0,i.kt)("strong",{parentName:"p"},"Format Email")," along with the users email. This time it will generate a link to a page called ",(0,i.kt)("inlineCode",{parentName:"p"},"/reset-password"),". You can edit the content of the email in the ",(0,i.kt)("strong",{parentName:"p"},"Format Email")," node."),(0,i.kt)("div",{className:"ndl-image-with-background xl"},(0,i.kt)("p",null,(0,i.kt)("img",{src:a(45582).Z,width:"746",height:"234"}))),(0,i.kt)("p",null,"The resulting link will look something like this:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},'<a href="https://your-app.sandbox.noodl.app/reset-password?token=abc&email=user@email.com">link</a>')),(0,i.kt)("p",null,"The link will take the user to the ",(0,i.kt)("inlineCode",{parentName:"p"},"/reset-password")," page which can contain a ",(0,i.kt)("strong",{parentName:"p"},"Text Input")," where the user can provide the new password."),(0,i.kt)("div",{className:"ndl-image-with-background xl"},(0,i.kt)("p",null,(0,i.kt)("img",{src:a(75959).Z,width:"874",height:"620"}))),(0,i.kt)("p",null,"When the user hits the reset button we will call the ",(0,i.kt)("strong",{parentName:"p"},"Sign Up / Reset Password")," cloud function by supplying the secret token and user email that is received via the query parameters of the link and the ",(0,i.kt)("strong",{parentName:"p"},"Page Inputs")," node."),(0,i.kt)("div",{className:"ndl-image-with-background xl"},(0,i.kt)("p",null,(0,i.kt)("img",{src:a(54275).Z,width:"1618",height:"1052"}))),(0,i.kt)("p",null,"Provided that the secret token is correct and have not expired (tokens are valid for 24 hours) the password will be updated. You can then send the user back to the ",(0,i.kt)("strong",{parentName:"p"},"Log In")," page."),(0,i.kt)("p",null,"That's it, this is how you use cloud functions to create an email verification and password reset flow. You will use cloud functions for a lot of user management tasks that need to be performed on the backend with full database access."))}h.isMDXComponent=!0},93627:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/reset-password-1-febc05010706aa49fdce5f4619d10e78.png"},46999:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/reset-password-2-79045cdca35a317964da8534d57d9f39.png"},77383:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/reset-password-3-f154724ee794a8a59fad7e835d05f7e6.png"},45582:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/reset-password-4-f1efc4e317f5c2315752e77c4bf88371.png"},54275:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/reset-password-5-5ab4fc013361523677751d194ac49e57.png"},75959:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/reset-password-6-226403f0ac6e03a25f04f9d15779f6dd.png"},38882:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/settings-57b7bccf9cb884ef40b4cc240596d010.png"},33384:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/sign-up-1-17865ab4ce36b2f70baf6cecd14e46e9.png"},21699:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/sign-up-2-020e1d4b27e1c2cc4d910816afbe4960.png"},79703:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/sign-up-3-e22cedf8db53eb32a90d32f5a321c47d.png"},3347:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/sign-up-4-bf4d759cca940264554b8b8503eedf2f.png"},96065:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/sign-up-5-bf0a3f3d5d4099bcc2451c2652204f98.png"},7069:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/signup-template-15cd4d1a6d6fce354bcefb13224db64b.png"},56182:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/verify-email-1-faad07be3e8ac8eedcc96c03052d30e3.png"},37720:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/verify-email-2-0c5d11fed1967cea0f515c9c58299f19.png"}}]);